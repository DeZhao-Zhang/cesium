<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <!-- Include the CesiumJS JavaScript and CSS files -->
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.111/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.111/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  <script src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>

    <style>
    @import url(../templates/bucket.css);

    #toolbar {
      background: rgba(42, 42, 42, 0.8);
      padding: 4px;
      border-radius: 4px;
    }

    #toolbar input {
      vertical-align: middle;
      padding-top: 2px;
      padding-bottom: 2px;
    }

    #toolbar table tr {
      transform: translateY(0);
      transition: transform 0.4s ease-out;
    }

    #toolbar table tr.up {
      transform: translateY(33px);
      transition: none;
    }

    #toolbar table tr.down {
      transform: translateY(-33px);
      transition: none;
    }
  </style>
</head>
<body>
<div id="cesiumContainer" class="fullSize"></div>
<div id="loadingOverlay"><h1>Loading...</h1></div>
<div id="toolbar">
  <div>
    <input
      type="checkbox"
      id="subscribeNews"
      checked="checked"
    />
    <label for="subscribeNews">图层调整</label>
  </div>

  <table id="layersTable">
    <tbody data-bind="foreach: layers">
    <tr
      data-bind="css: { up: $parent.upLayer === $data, down: $parent.downLayer === $data }"
    >
      <td><input type="checkbox" data-bind="checked: show" /></td>
      <td>
              <span
                data-bind="text: name, visible: !$parent.isSelectableLayer($data)"
              ></span>
        <select
          data-bind="visible: $parent.isSelectableLayer($data), options: $parent.baseLayers, optionsText: 'name', value: $parent.selectedLayer"
        ></select>
      </td>
      <td>
        <input
          type="range"
          min="0"
          max="1"
          step="0.01"
          data-bind="value: alpha, valueUpdate: 'input'"
        />
      </td>
      <td>
        <button
          type="button"
          class="cesium-button"
          data-bind="click: function() { $parent.raise($data, $index()); }, visible: $parent.canRaise($index())"
        >
          ▲
        </button>
      </td>
      <td>
        <button
          type="button"
          class="cesium-button"
          data-bind="click: function() { $parent.lower($data, $index()); }, visible: $parent.canLower($index())"
        >
          ▼
        </button>
      </td>
    </tr>
    </tbody>
  </table>
</div>
<script type="module">
  Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI3ZTFhN2Y1OS1lYjUxLTRjZmYtODQxZi1mZTM4MDU4NWYwMWUiLCJpZCI6MTI5NDE3LCJpYXQiOjE2NzkyODg1ODJ9.XnmmLyiHnjdFa9BJZzCnz7f8zGZXh5RP_quL6nHd9Ts';

  // Initialize the Cesium Viewer in the HTML element with the `cesiumContainer` ID.
  const viewer = new Cesium.Viewer('cesiumContainer',
    {
      geocoder: true, //搜索框
      homeButton: false, //home按钮
      sceneModePicker: true, //3d/2d 模式切换按钮
      baseLayerPicker: false, //图层选择按钮
      navigationHelpButton: false, //右上角的帮助按钮
      animation: false, //左下角的动画控件的显示
      shouldAnimate: false, //控制模型动画
      timeline: false, //底部的时间轴
      fullscreenButton: false, //右下角的全屏按钮
      selectionIndicator: true, //选择指示器
      infoBox: true, //信息面板
    });

  viewer._cesiumWidget._creditContainer.style.display = "none"; //隐藏logo版权

  // 设置相机位置
  viewer.camera.setView({
    // 设置相机位置
    destination : Cesium.Cartesian3.fromDegrees(115.924598,39.045307, 15000.0),

  });

  $("#subscribeNews").click(function(){
    if ($('#subscribeNews').is(':checked') == true){
      $("#layersTable").show()
    }else {
      $("#layersTable").hide()
    }
  })
  // 不显示底图
  viewer.imageryLayers.get(0).show = false;

  const imageryLayers = viewer.imageryLayers;

  const viewModel = {
    layers: [],
    baseLayers: [],
    upLayer: null,
    downLayer: null,
    selectedLayer: null,
    isSelectableLayer: function (layer) {
      return this.baseLayers.indexOf(layer) >= 0;
    },
    raise: function (layer, index) {
      imageryLayers.raise(layer);
      viewModel.upLayer = layer;
      viewModel.downLayer = viewModel.layers[Math.max(0, index - 1)];
      updateLayerList();
      window.setTimeout(function () {
        viewModel.upLayer = viewModel.downLayer = null;
      }, 10);
    },
    lower: function (layer, index) {
      imageryLayers.lower(layer);
      viewModel.upLayer =
        viewModel.layers[
          Math.min(viewModel.layers.length - 1, index + 1)
          ];
      viewModel.downLayer = layer;
      updateLayerList();
      window.setTimeout(function () {
        viewModel.upLayer = viewModel.downLayer = null;
      }, 10);
    },
    canRaise: function (layerIndex) {
      return layerIndex > 0;
    },
    canLower: function (layerIndex) {
      return layerIndex >= 0 && layerIndex < imageryLayers.length - 1;
    },
  };
  const baseLayers = viewModel.baseLayers;

  Cesium.knockout.track(viewModel);

  function setupLayers() {
    // Create all the base layers that this example will support.
    // These base layers aren't really special.  It's possible to have multiple of them
    // enabled at once, just like the other layers, but it doesn't make much sense because
    // all of these layers cover the entire globe and are opaque.
    addBaseLayerOption(
      "Bing Maps Aerial",
      Cesium.createWorldImageryAsync()
    );
    addBaseLayerOption(
      "Bing Maps Road",
      Cesium.createWorldImageryAsync({
        style: Cesium.IonWorldImageryStyle.ROAD,
      })
    );
    addBaseLayerOption(
      "ArcGIS World Street Maps",
      Cesium.ArcGisMapServerImageryProvider.fromUrl(
        "https://services.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer"
      )
    );
    addBaseLayerOption(
      "OpenStreetMaps",
      new Cesium.OpenStreetMapImageryProvider()
    );

    addBaseLayerOption(
      "高德矢量地图",
       new Cesium.UrlTemplateImageryProvider({
        url: "http://webrd02.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}",
        layer: "tdtVecBasicLayer",
        style: "default",
        format: "image/png",
        tileMatrixSetID: "GoogleMapsCompatible"
      })
    )

    addBaseLayerOption(
      "高德影像",
      new Cesium.UrlTemplateImageryProvider({
        url: "https://webst02.is.autonavi.com/appmaptile?style=6&x={x}&y={y}&z={z}",
        minimumLevel: 3,
        maximumLevel: 18
      })
    )

    addBaseLayerOption(
      "天地图影像",
      new Cesium.WebMapTileServiceImageryProvider({
        url: "http://t0.tianditu.com/img_w/wmts?service=wmts&request=GetTile&version=1.0.0&LAYER=img&tileMatrixSet=w&TileMatrix={TileMatrix}&TileRow={TileRow}&TileCol={TileCol}&style=default&format=tiles&tk=307cc6ed3afdd4786849ad82b42385ab",
        layer: "tdtBasicLayer",
        style: "default",
        format: "image/jpeg",
        tileMatrixSetID: "GoogleMapsCompatible"
      })
    )

    addAdditionalLayerOption(
      "天地图矢量底图",
      new Cesium.WebMapTileServiceImageryProvider({               //全球矢量底图服务
        url: "http://t0.tianditu.gov.cn/vec_w/wmts?service=wmts&request=GetTile&version=1.0.0&LAYER=vec&tileMatrixSet=w&TileMatrix={TileMatrix}&TileRow={TileRow}&TileCol={TileCol}&style=default&format=tiles&tk=307cc6ed3afdd4786849ad82b42385ab",
        subdomains: ['0','1','2','3','4','5','6','7'],
        layer: "tdtImgLayer",
        style: "default",
        format: "image/jpeg",
        tileMatrixSetID: "GoogleMapsCompatible",//使用谷歌的瓦片切片方式
        show: true
      }),
      0.8, false
    )

    addAdditionalLayerOption(
      "天地图矢量注记",
      new Cesium.WebMapTileServiceImageryProvider({
        url:"http://t0.tianditu.gov.cn/cva_w/wmts?service=wmts&request=GetTile&version=1.0.0&LAYER=cva&tileMatrixSet=w&TileMatrix={TileMatrix}&TileRow={TileRow}&TileCol={TileCol}&style=default&format=tiles&tk=307cc6ed3afdd4786849ad82b42385ab",
        layer: "tdtCvaLayer",
        style: "default",
        format: "image/jpeg",
        tileMatrixSetID: "GoogleMapsCompatible",
      }),0.8, false
    )

    addAdditionalLayerOption(
      "天地图影像注记",
      new Cesium.WebMapTileServiceImageryProvider({
        url:"http://t0.tianditu.gov.cn/cia_w/wmts?service=wmts&request=GetTile&version=1.0.0&LAYER=cia&tileMatrixSet=w&TileMatrix={TileMatrix}&TileRow={TileRow}&TileCol={TileCol}&style=default&format=tiles&tk=307cc6ed3afdd4786849ad82b42385ab",
        layer: "tdtCiaLayer",
        style: "default",
        format: "image/jpeg",
        tileMatrixSetID: "GoogleMapsCompatible", }),0.8, false
    )

    // Create the additional layers
    addAdditionalLayerOption(
      "长光(Xiong An)",
      new Cesium.UrlTemplateImageryProvider({
        url : 'https://minio-api.csnd.com/rs-image/{z}_{x}_{y}.png',
      }),0.8,true
    );
  }

  async function addBaseLayerOption(name, imageryProviderPromise) {
    try {
      const imageryProvider = await Promise.resolve(
        imageryProviderPromise
      );

      const layer = new Cesium.ImageryLayer(imageryProvider);
      layer.name = name;
      baseLayers.push(layer);
      updateLayerList();
    } catch (error) {
      console.error(
        `There was an error while creating ${name}. ${error}`
      );
    }
  }

  async function addAdditionalLayerOption(
    name,
    imageryProviderPromise,
    alpha,
    show
  ) {
    try {
      const imageryProvider = await Promise.resolve(
        imageryProviderPromise
      );
      const layer = new Cesium.ImageryLayer(imageryProvider);
      layer.alpha = Cesium.defaultValue(alpha, 0.5);
      layer.show = Cesium.defaultValue(show, true);
      layer.name = name;
      imageryLayers.add(layer);
      Cesium.knockout.track(layer, ["alpha", "show", "name"]);
      updateLayerList();
    } catch (error) {
      console.error(
        `There was an error while creating ${name}. ${error}`
      );
    }
  }

  function updateLayerList() {
    const numLayers = imageryLayers.length;
    viewModel.layers.splice(0, viewModel.layers.length);
    for (let i = numLayers - 1; i >= 0; --i) {
      viewModel.layers.push(imageryLayers.get(i));
    }
  }

  setupLayers();

  //Bind the viewModel to the DOM elements of the UI that call for it.
  const toolbar = document.getElementById("toolbar");
  Cesium.knockout.applyBindings(viewModel, toolbar);

  Cesium.knockout
    .getObservable(viewModel, "selectedLayer")
    .subscribe(function (baseLayer) {
      // Handle changes to the drop-down base layer selector.
      let activeLayerIndex = 0;
      const numLayers = viewModel.layers.length;
      for (let i = 0; i < numLayers; ++i) {
        if (viewModel.isSelectableLayer(viewModel.layers[i])) {
          activeLayerIndex = i;
          break;
        }
      }
      const activeLayer = viewModel.layers[activeLayerIndex];
      const show = activeLayer.show;
      const alpha = activeLayer.alpha;
      imageryLayers.remove(activeLayer, false);
      imageryLayers.add(baseLayer, numLayers - activeLayerIndex - 1);
      baseLayer.show = true;
      baseLayer.alpha = alpha;
      updateLayerList();
    });

</script>
</div>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <!-- Include the CesiumJS JavaScript and CSS files -->
  <script src="https://cdn.staticfile.org/jquery/1.10.2/jquery.min.js"></script>
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.103/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.103/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
</head>
<style>
  * {
    padding: 0;
    margin: 0;
  }

  html,body{
    height: 100%;
  }
</style>
<body>
  <div id="cesiumContainer" style="width: 100%; height: 100%"></div>
  <div class="layer" style="position: absolute; top: 20px">
    <input type="range" id="myRange" value="100" max="100" style="width: 200px">
  </div>
  <div>
    <p id="data_title" style="position: absolute;top: 20px;left: 40%; color:#fdfffc;font-size:40px;">密云水库</p>
  </div>
  <script>

  Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI3ZTFhN2Y1OS1lYjUxLTRjZmYtODQxZi1mZTM4MDU4NWYwMWUiLCJpZCI6MTI5NDE3LCJpYXQiOjE2NzkyODg1ODJ9.XnmmLyiHnjdFa9BJZzCnz7f8zGZXh5RP_quL6nHd9Ts';

  // Initialize the Cesium Viewer in the HTML element with the `cesiumContainer` ID.
  const viewer = new Cesium.Viewer('cesiumContainer', {
    terrainProvider: Cesium.createWorldTerrain(),
    shouldAnimate: false,
  });

  viewer.camera.setView({
    destination: Cesium.Cartesian3.fromDegrees(116.904773, 40.490197, 50000)
  })
  // 起始和截至时间
  const start_time = "1984-05-12";
  const end_time = "2020-08-30";
  // 时间更新的快慢(15天)
  const time_update = 15;
  const time_multiplier = 3600 * 24 * time_update;
  // 图层透明度
  const layer_alpha = 1;
  // 图层链接 (Time 对应更新之后的时间) ({Time}/{TileMatrixSet}/{TileMatrix}/{TileRow}/{TileCol}.jpg 组成需要请求的图层链接信息)
  const tileMatrixSetID =  "MiYun"; // 字符串标识符(固定即可)
  const layer_url = "http://localhost:3000/zhitu/{Time}/{TileMatrixSet}/{TileMatrix}/{TileCol}/{TileRow}.png"

  // eslint-disable-next-line no-implicit-globals,strict
  const time_list = [19840512, 19840613, 19840629, 19840816, 19841003, 19841019, 19841120, 19841206, 19841222, 19850208, 19850312, 19850515, 19850531, 19850702, 19850819, 19850904, 19851022, 19851107, 19860110, 19860227, 19860315, 19860331, 19860416, 19860603, 19861025, 19861110, 19861126, 19861212, 19870419, 19870521, 19870622, 19870708, 19870910, 19870926, 19871012, 19871113, 19871215, 19871231, 19880116, 19880201, 19880217, 19880304, 19880320, 19880405, 19880421, 19880507, 19880608, 19880624, 19880726, 19880811, 19880912, 19880928, 19881014, 19881030, 19881115, 19881201, 19881217, 19890307, 19890323, 19890408, 19890424, 19890526, 19890627, 19890814, 19890830, 19890915, 19891001, 19891017, 19891102, 19891118, 19891204, 19891220, 19900105, 19900121, 19900206, 19900222, 19900310, 19900326, 19900427, 19900513, 19900529, 19900614, 19900630, 19900716, 19900817, 19900902, 19900918, 19901020, 19901121, 19901207, 19901223, 19910108, 19910124, 19910225, 19910313, 19910329, 19910414, 19910516, 19910601, 19910617, 19910703, 19910719, 19910804, 19910820, 19910905, 19910921, 19911007, 19911108, 19911124, 19911210, 19911226, 19920111, 19920127, 19920212, 19920228, 19920315, 19920331, 19920416, 19920502, 19920518, 19920603, 19920619, 19920705, 19920721, 19920806, 19920822, 19920907, 19920923, 19921009, 19921025, 19921110, 19921126, 19921212, 19921228, 19930113, 19930129, 19930214, 19930302, 19930419, 19930505, 19930606, 19930622, 19930708, 19930724, 19930809, 19930825, 19930910, 19931012, 19931028, 19931129, 19931215, 19931231, 19940116, 19940305, 19940321, 19940406, 19940422, 19940508, 19940524, 19940609, 19940727, 19940812, 19940913, 19940929, 19941031, 19941202, 19941218, 19950119, 19950324, 19950409, 19950425, 19950511, 19950527, 19950612, 19950628, 19950714, 19950730, 19950815, 19950831, 19950916, 19951002, 19951018, 19951119, 19951205, 19951221, 19960106, 19960122, 19960207, 19960223, 19960310, 19960326, 19960411, 19960427, 19960513, 19960529, 19960614, 19960630, 19960716, 19960817, 19960902, 19960918, 19961004, 19961020, 19970209, 19970225, 19970329, 19970414, 19970430, 19970516, 19970601, 19970703, 19970719, 19970804, 19970905, 19970921, 19971007, 19971023, 19971108, 19971124, 19971210, 19971226, 19980111, 19980127, 19980212, 19980401, 19980417, 19980503, 19980604, 19980722, 19980807, 19980823, 19980908, 19980924, 19981010, 19981026, 19981111, 19981127, 19981213, 19981229, 19990114, 19990130, 19990303, 19990319, 19990420, 19990506, 19990522, 19990607, 19990623, 19990709, 19990725, 19990810, 19990826, 19990911, 19991029, 19991114, 19991130, 19991216, 20000117, 20000202, 20000218, 20000305, 20000321, 20000406, 20000422, 20000508, 20000524, 20000609, 20000625, 20000727, 20000812, 20000828, 20000913, 20000929, 20001015, 20001031, 20001116, 20001202, 20001218, 20010103, 20010119, 20010204, 20010220, 20010308, 20010324, 20010409, 20010425, 20010527, 20010612, 20010628, 20010714, 20010730, 20010815, 20010831, 20010916, 20011002, 20011018, 20011103, 20011119, 20011221, 20020106, 20020122, 20020207, 20020223, 20020311, 20020327, 20020412, 20020428, 20020514, 20020615, 20020701, 20020717, 20020802, 20020818, 20020919, 20021005, 20021021, 20021106, 20021122, 20021208, 20021224, 20030109, 20030210, 20030226, 20030314, 20030330, 20030415, 20030501, 20030517, 20030602, 20030618, 20030704, 20030720, 20030805, 20030821, 20030906, 20030922, 20031008, 20031024, 20031109, 20031211, 20031227, 20040112, 20040128, 20040213, 20040316, 20040401, 20040417, 20040503, 20040519, 20040604, 20040620, 20040706, 20040722, 20040807, 20040823, 20040908, 20040924, 20041010, 20041026, 20041111, 20041127, 20041213, 20041229, 20050114, 20050130, 20050303, 20050319, 20050404, 20050420, 20050506, 20050522, 20050607, 20050623, 20050709, 20050725, 20050810, 20050826, 20050911, 20050927, 20051013, 20051029, 20051114, 20060202, 20060218, 20060306, 20060407, 20060509, 20060610, 20060626, 20060712, 20060728, 20060813, 20060829, 20060914, 20060930, 20061016, 20061101, 20061117, 20061203, 20061219, 20070104, 20070120, 20070205, 20070221, 20070309, 20070325, 20070410, 20070426, 20070512, 20070528, 20070613, 20070715, 20070731, 20070816, 20070901, 20070917, 20071003, 20080208, 20080224, 20080311, 20080327, 20080412, 20080428, 20080514, 20080530, 20080615, 20080701, 20080802, 20080818, 20080903, 20081005, 20081021, 20090125, 20090210, 20090226, 20090314, 20090330, 20090415, 20090501, 20090517, 20090602, 20090618, 20090704, 20090720, 20090805, 20090821, 20090906, 20090922, 20091008, 20091024, 20091109, 20091125, 20091211, 20100128, 20100213, 20100301, 20100317, 20100402, 20100418, 20100504, 20100520, 20100605, 20100621, 20100723, 20100808, 20100824, 20100925, 20101011, 20101128, 20101214, 20110115, 20110131, 20110216, 20110304, 20110320, 20110405, 20110421, 20110507, 20110523, 20110608, 20110624, 20110710, 20110726, 20111030, 20111115, 20130426, 20130512, 20130528, 20130613, 20130629, 20130731, 20130816, 20130901, 20130917, 20131003, 20131019, 20131104, 20131120, 20131206, 20131222, 20140107, 20140123, 20140208, 20140224, 20140312, 20140328, 20140413, 20140429, 20140515, 20140531, 20140616, 20140702, 20140718, 20140803, 20140819, 20140904, 20140920, 20141006, 20141022, 20141107, 20141123, 20141209, 20141225, 20150110, 20150126, 20150227, 20150315, 20150331, 20150416, 20150502, 20150518, 20150603, 20150619, 20150705, 20150721, 20150806, 20150822, 20150907, 20150923, 20151009, 20151025, 20151110, 20151126, 20151212, 20151228, 20160113, 20160129, 20160214, 20160301, 20160317, 20160402, 20160418, 20160504, 20160520, 20160605, 20160621, 20160707, 20160723, 20160808, 20160824, 20160909, 20160925, 20161011, 20161027, 20161112, 20161128, 20161214, 20161230, 20170115, 20170131, 20170216, 20170304, 20170320, 20170405, 20170421, 20170507, 20170523, 20170608, 20170624, 20170710, 20170726, 20170811, 20170827, 20170912, 20170928, 20171014, 20171030, 20171115, 20171201, 20171217, 20180102, 20180118, 20180203, 20180219, 20180307, 20180323, 20180408, 20180424, 20180510, 20180526, 20180611, 20180627, 20180713, 20180729, 20180814, 20180830, 20180915, 20181001, 20181017, 20181102, 20181118, 20181204, 20181220, 20190105, 20190121, 20190206, 20190222, 20190310, 20190326, 20190411, 20190427, 20190513, 20190529, 20190614, 20190630, 20190716, 20190801, 20190817, 20190902, 20190918, 20191004, 20191020, 20191105, 20191121, 20191207, 20191223, 20200108, 20200124, 20200209, 20200225, 20200312, 20200328, 20200413, 20200429, 20200515, 20200531, 20200616, 20200702, 20200718, 20200803, 20200819, 20200901]
  function dataCallback(interval, index) {
    let time;
    if (index === 0) {
      // leading
      time = Cesium.JulianDate.toIso8601(interval.stop);
    } else {
      time = Cesium.JulianDate.toIso8601(interval.start);
    }

    let curTime = parseInt(time.split("T")[0].split("-")[0] + time.split("T")[0].split("-")[1] + time.split("T")[0].split("-")[2])
    let resTime;

    for (let i=0;i<time_list.length;i++){
      if (curTime >= time_list[i] & curTime < time_list[i + 1]){
        resTime = String(time_list[i])
        break
      }
    }

    return {
      Time: resTime.substring(0, 4) + "-" + resTime.substring(4, 6) + "-" + resTime.substring(6, 8),
    };
  }

  // 创建时间对象 并更新传递的时间参数
  const times = Cesium.TimeIntervalCollection.fromIso8601({
    iso8601: `${start_time}/${end_time}/P${time_update}D`,
    leadingInterval: true,
    trailingInterval: true,
    isStopIncluded: false, // We want stop time to be part of the trailing interval
    dataCallback: dataCallback,
  });

  // 创建图层对象
  const provider = new Cesium.WebMapTileServiceImageryProvider({
    url: layer_url,
    layer: "MiYun",
    style: "default",
    tileMatrixSetID: tileMatrixSetID,
    format: "image/jpeg",
    clock: viewer.clock,
    times: times,
  });
  // 添加图层
  const imageryLayers = viewer.imageryLayers;
  const layer = imageryLayers.addImageryProvider(provider);

  // 设置图层更新规则
  // eslint-disable-next-line strict
  provider.readyPromise.then(function () {


    const start = Cesium.JulianDate.fromIso8601(`${start_time}`);
    const stop = Cesium.JulianDate.fromIso8601(`${end_time}`);

    viewer.timeline.zoomTo(start, stop);

    const clock = viewer.clock;
    clock.startTime = start;
    clock.stopTime = stop;
    clock.currentTime = start;
    clock.clockRange = Cesium.ClockRange.LOOP_STOP;
    // 时间变化的快慢
    clock.multiplier = time_multiplier;
    // Make the weather layer semi-transparent to see the underlying geography.
    layer.alpha = layer_alpha;
  });

  const clock = viewer.clock;
  // 更改当前的时间
  function tick(){
    const currentTime = Cesium.JulianDate.toIso8601(clock.currentTime);
    let curTime = parseInt(currentTime.split("T")[0].split("-")[0] + currentTime.split("T")[0].split("-")[1] + currentTime.split("T")[0].split("-")[2])
    let resTime;

    for (let i=0;i<time_list.length;i++){
      if (curTime >= time_list[i] & curTime < time_list[i + 1]){
        resTime = String(time_list[i])
        break
      }
    }

    let data_name = "密云水库: " + resTime.substring(0, 4) + "-" + resTime.substring(4, 6) + "-" + resTime.substring(6, 8)
    $("#data_title").text(data_name);
    requestAnimationFrame(tick);
  }
  requestAnimationFrame(tick);

  // 需改透明度
  $(document).ready(function(){
    $('#myRange').change(function () {
      let opacity = $('#myRange').val() / 100;
      layer.alpha = opacity;
    });
  });

  </script>
</body>
</html>
